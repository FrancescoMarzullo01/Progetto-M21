<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
<!--  Refresh pagina ogni 20 secondi  -->
<meta charset="UTF-8" http-equiv="refresh" content="20">
<title>view Orders</title>

<link rel="stylesheet" href="/CSS/bootstrap.css">
<link rel="stylesheet" href="/CSS/style.css">
<script src="/JS/notification.js" type="text/javascript"></script>

</head>
<body>
	<div th:replace="fragments/components :: navbar"></div>
	<section id="fh5co-home" data-section="home">
		<div class="container">
			<div class="col-md-12">
				<div class="panel panel-default">
					<div class="panel-heading">Orders</div>
					<div class="panel-body">
						<div class="wrapper">

							<!-- TABELLA PRINCIPALE -->
							<table class="table table-condensed table-striped">

								<!--  INTESTAZIONE TABELLA PRINCIPALE: 8 colonne -->
								<thead>
									<tr>
										<th></th>
										<th>Order ID</th>
										<th>Tracking Code</th>
										<th>Pickup Code</th>
										<th>Locker Name</th>
										<th>Locker address</th>
										<th>Status</th>
										<th sec:authorize="hasAnyAuthority('CUSTOMER')">Withdraw</th>
										<th sec:authorize="hasAnyAuthority('COURIER')">Deliver</th>
									</tr>
								</thead>
								<!--  INTESTAZIONE TABELLA PRINCIPALE: 8 colonne -->


								<!--  CORPO TABELLA PRINCIPALE -->
								<tbody>

									<!-- PER OGNI ORDINE -->
									<th:block th:each="order : ${listOrders}">

										<!--#1 7 COLONNE + BOTTONE -->
										<tr>
											<td>
												<button class="btn btn-default btn-xs" data-toggle="collapse"
													th:data-target="|#demo${order.orderDetailsId}|">
													<span class="glyphicon glyphicon-eye-open"></span>
												</button>
											</td>

											<td th:text="${order.orderDetailsId}">Order ID</td>
											<td th:text="${order.trackingCode}">Tracking Code</td>
											<td th:text="${order.pickupCode} ?: ''">Pickup Code</td>
											<td th:text="${order.locker.name} ?: ''">Locker Name</td>
											<td th:text="${order.locker.lockerAddress.city} ?: ''">Locker address</td>
											<td th:text="${order.deliveryDetails.deliveryStatus}">Status</td>

											<!-- VERIFICA LO STATO E IL RUOLO DELL'UTENTE PER INSERIMENTO DELL'APPOSITO PULSANTE -->
											<td th:switch="${#strings.toString(order.deliveryDetails.deliveryStatus)}">

												<span th:case="'DELIVERED'" sec:authorize="hasAnyAuthority('CUSTOMER')">
													<a style="color: green !important;" th:href="@{'/withdraw/' + ${order.orderDetailsId}}">Withdraw</a>

													<!--  NOTIFICA CUSTOMER  -->
													<script th:inline="javascript">
														var orderId = /*[[${order.orderDetailsId}]]*/'';
														var role = /*[[${#authentication.getPrincipal().getUser().getRole().getName()}]]*/'';
														notify(orderId, role);
													</script>

												</span>

												<span th:case="'DELIVERING'" sec:authorize="hasAnyAuthority('COURIER')">
													<a style="color: green !important;" th:href="@{'/deliver/' + ${order.orderDetailsId}}">Deliver</a>
												</span>

												<span th:case="'WITHDRAWN'" sec:authorize="hasAnyAuthority('COURIER')">
												
													<!--  NOTIFICA COURIER  -->
													<script th:inline="javascript">
														var orderId = /*[[${order.orderDetailsId}]]*/'';
														var role = /*[[${#authentication.getPrincipal().getUser().getRole().getName()}]]*/'';
														notify(orderId, role);
													</script>
												</span>

												<div th:case="*"></div>
											</td>
										</tr>

										<!--#2 TABELLA SECONDARIA: 3 colonne -->
										<tr>
											<td colspan="8" style="padding: 0 !important;">

												<div th:id="|demo${order.orderDetailsId}|" class="accordian-body accordion-toggle collapse">
													<table class="table table-striped">
														<thead>
															<tr class="info">
																<th>Delivery Date</th>
																<th>Data Deliverd</th>
																<th>Withdrawal Date</th>
															</tr>
														</thead>

														<tbody>

															<tr>
																<td th:text="${order.deliveryDetails.deliveryDate} ?: 'null'"></td>
																<td th:text="${order.deliveryDetails.dataDeliverd} ?: 'null'"></td>
																<td th:text="${order.deliveryDetails.withdrawalDate} ?: 'null'"></td>
															</tr>

															<!--  SOTTO-TABELLA SECONDARIA -->
														<thead sec:authorize="hasAnyAuthority('CUSTOMER')">
															<tr class="info">
																<td>Height</td>
																<td>Length</td>
																<td>Weight</td>
																<td>Width</td>
															</tr>
														</thead>

														<tbody sec:authorize="hasAnyAuthority('CUSTOMER')">
															<tr th:each="product : ${order.products}">
																<td th:text="${product.height} ?: 'null'"></td>
																<td th:text="${product.length} ?: 'null'"></td>
																<td th:text="${product.weight} ?: 'null'"></td>
																<td th:text="${product.width} ?: 'null'"></td>
															</tr>
														</tbody>

													</table>
												</div>
											</td>
										</tr>
									</th:block>

								</tbody>
								<!--  CORPO TABELLA PRINCIPALE -->

							</table>
							<!-- TABELLA PRINCIPALE -->

						</div>
					</div>
				</div>
			</div>
		</div>
	</section>
	<div th:insert="fragments/components :: footer"></div>

	<script src="/JS/jquery.min.js"></script>
	<script src="/JS/bootstrap.min.js"></script>


</body>
</html>